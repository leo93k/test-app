name: Deploy to EC2

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    CONTAINER_NAME: crawling-app

jobs:
    deploy:
        name: Deploy to EC2
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  # SSH í‚¤ íŒŒì¼ ìƒì„±
                  cat > ~/.ssh/deploy_key << 'KEYEOF'
                  ${{ secrets.EC2_SSH_KEY }}
                  KEYEOF
                  chmod 600 ~/.ssh/deploy_key

                  # known_hostsì— EC2 í˜¸ìŠ¤íŠ¸ ì¶”ê°€
                  ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
                  chmod 644 ~/.ssh/known_hosts

            - name: Deploy files to EC2
              env:
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  EC2_USER: ${{ secrets.EC2_USER }}
                  DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH || '~/app' }}
              run: |
                  # EC2ë¡œ íŒŒì¼ ì „ì†¡ (.git, node_modules ì œì™¸)
                  DEPLOY_PATH_RAW="${{ secrets.EC2_DEPLOY_PATH || '~/app' }}"

                  # ê²½ë¡œë¥¼ SSHë¡œ í™•ì¸í•˜ê³  ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
                  ACTUAL_PATH=$(ssh -i ~/.ssh/deploy_key \
                      -o StrictHostKeyChecking=no \
                      -o UserKnownHostsFile=~/.ssh/known_hosts \
                      ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
                      "DEPLOY_PATH_RAW='$DEPLOY_PATH_RAW'
                      if [[ \"\$DEPLOY_PATH_RAW\" == ~* ]]; then
                        echo \"\${HOME}\${DEPLOY_PATH_RAW#\~}\"
                      else
                        echo \"\$DEPLOY_PATH_RAW\"
                      fi")

                  # ê²½ë¡œê°€ ë¹„ì–´ìˆê±°ë‚˜ ë£¨íŠ¸ì¸ ê²½ìš° ì—ëŸ¬
                  if [ -z "$ACTUAL_PATH" ] || [ "$ACTUAL_PATH" = "/" ]; then
                      echo "âŒ Error: Invalid deployment path: $ACTUAL_PATH"
                      exit 1
                  fi

                  echo "ğŸ“ Deploying to: $ACTUAL_PATH"

                  # ë°°í¬ ê²½ë¡œ ë””ë ‰í† ë¦¬ ìƒì„±
                  ssh -i ~/.ssh/deploy_key \
                      -o StrictHostKeyChecking=no \
                      -o UserKnownHostsFile=~/.ssh/known_hosts \
                      ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
                      "mkdir -p '$ACTUAL_PATH'"

                  # rsyncë¡œ íŒŒì¼ ì „ì†¡ (--deleteëŠ” ë°°í¬ ê²½ë¡œ ë‚´ì—ì„œë§Œ ì ìš©)
                  rsync -avz \
                    -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts" \
                    --exclude '.git' \
                    --exclude 'node_modules' \
                    --exclude '.next' \
                    --exclude '.env*' \
                    --exclude '*.log' \
                    --exclude '.DS_Store' \
                    --delete \
                    ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$ACTUAL_PATH/

            - name: Build and deploy on EC2
              env:
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  EC2_USER: ${{ secrets.EC2_USER }}
                  DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH || '~/app' }}
              run: |
                  ssh -i ~/.ssh/deploy_key \
                      -o StrictHostKeyChecking=no \
                      -o UserKnownHostsFile=~/.ssh/known_hosts \
                      -o ConnectTimeout=10 \
                      ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                  set -e

                  CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
                  DEPLOY_PATH_RAW="${{ secrets.EC2_DEPLOY_PATH || '~/app' }}"

                  # ë°°í¬ ê²½ë¡œ ì„¤ì • (~ë¥¼ $HOMEìœ¼ë¡œ í™•ì¥)
                  if [[ "$DEPLOY_PATH_RAW" == ~* ]]; then
                      DEPLOY_PATH="${DEPLOY_PATH_RAW/#\~/$HOME}"
                  else
                      DEPLOY_PATH="$DEPLOY_PATH_RAW"
                  fi

                  echo "ğŸ“ Deployment path: $DEPLOY_PATH"
                  cd "$DEPLOY_PATH" || exit 1

                  # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
                  if ! command -v rsync &> /dev/null; then
                      echo "ğŸ“¦ Installing rsync..."
                      sudo apt-get update
                      sudo apt-get install -y rsync
                  fi

                  # Docker ì„¤ì¹˜ í™•ì¸
                  if ! command -v docker &> /dev/null; then
                      echo "ğŸ“¦ Installing Docker..."
                      sudo apt-get update
                      sudo apt-get install -y \
                          ca-certificates \
                          curl \
                          gnupg \
                          lsb-release
                      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                      sudo apt-get update
                      sudo apt-get install -y docker-ce docker-ce-cli containerd.io
                      sudo usermod -aG docker $USER
                      # Docker ì„¤ì¹˜ í™•ì¸
                      sudo docker --version
                  fi

                  # Docker ëª…ë ¹ì–´ ì‹¤í–‰ (sudo ì‚¬ìš© ë˜ëŠ” ê·¸ë£¹ ê¶Œí•œ í™•ì¸)
                  if docker ps &> /dev/null; then
                      echo "âœ… Docker is accessible"
                      DOCKER_CMD="docker"
                  else
                      echo "âš ï¸ Docker requires sudo, using sudo docker"
                      DOCKER_CMD="sudo docker"
                  fi

                  echo "âœ… Docker version: $($DOCKER_CMD --version)"

                  # docker-compose ì„¤ì¹˜ í™•ì¸
                  if ! command -v docker-compose &> /dev/null; then
                      echo "ğŸ“¦ Installing docker-compose..."
                      if [ "$DOCKER_CMD" = "sudo docker" ]; then
                          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                          sudo chmod +x /usr/local/bin/docker-compose
                      else
                          curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o ~/docker-compose
                          chmod +x ~/docker-compose
                          sudo mv ~/docker-compose /usr/local/bin/docker-compose
                      fi
                  fi

                  # docker-compose ëª…ë ¹ì–´ ì„¤ì •
                  if [ "$DOCKER_CMD" = "sudo docker" ]; then
                      COMPOSE_CMD="sudo docker-compose"
                  else
                      COMPOSE_CMD="docker-compose"
                  fi

                  echo "âœ… docker-compose version: $($COMPOSE_CMD --version)"

                  # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (docker-compose ì‚¬ìš©)
                  echo "ğŸ›‘ Stopping existing containers..."
                  $COMPOSE_CMD down --remove-orphans || true

                  # ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±° (íƒœê·¸ëœ ì´ë¯¸ì§€ í¬í•¨)
                  echo "ğŸ§¹ Removing old images..."
                  # í˜„ì¬ ì´ë¯¸ì§€ ì´ë¦„ìœ¼ë¡œ íƒœê·¸ëœ ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±°
                  if $DOCKER_CMD images --format '{{.Repository}}:{{.Tag}}' | grep -q "^${CONTAINER_NAME}:"; then
                      $DOCKER_CMD rmi ${CONTAINER_NAME}:latest || true
                  fi
                  # Dangling ì´ë¯¸ì§€ ì œê±° (íƒœê·¸ê°€ ì—†ëŠ” ì´ë¯¸ì§€)
                  $DOCKER_CMD image prune -f || true
                  # Build cache ì œê±° (ì„ íƒì‚¬í•­ - ë¹Œë“œ ì‹œê°„ì´ ëŠ˜ì–´ë‚  ìˆ˜ ìˆìŒ)
                  # $DOCKER_CMD builder prune -f || true

                  # ì´ì „ ë¹Œë“œ íŒŒì¼ ì •ë¦¬ (.next ìºì‹œ ë“±)
                  echo "ğŸ§¹ Cleaning build artifacts..."
                  rm -rf .next || true

                  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (docker-compose ì‚¬ìš©)
                  echo "ğŸ”¨ Building and starting containers with docker-compose..."
                  $COMPOSE_CMD up --build -d

                  # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                  echo "â³ Waiting for containers to start..."
                  sleep 5

                  if $COMPOSE_CMD ps | grep -q "Up"; then
                      echo "âœ… Container is running!"
                      $COMPOSE_CMD ps
                      echo ""
                      echo "ğŸ“‹ Container logs (last 20 lines):"
                      $COMPOSE_CMD logs --tail 20
                  else
                      echo "âŒ Container failed to start"
                      $COMPOSE_CMD logs || true
                      exit 1
                  fi

                  echo "âœ… Deployment completed successfully!"
                  EOF

            - name: Verify deployment
              run: |
                  echo "âœ… Deployment completed!"
                  echo "Container: ${{ env.CONTAINER_NAME }}"
                  echo "Host: ${{ secrets.EC2_HOST }}"
