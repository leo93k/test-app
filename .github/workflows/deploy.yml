name: Deploy to EC2

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    NODE_VERSION: "20"

jobs:
    deploy:
        name: Deploy to EC2
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "yarn"

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build application
              run: yarn build
              env:
                  NODE_ENV: production

            - name: Configure SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy to EC2
              env:
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  EC2_USER: ${{ secrets.EC2_USER }}
              run: |
                  # EC2Î°ú ÌååÏùº Ï†ÑÏÜ° (.next Ìè¨Ìï®, node_modulesÎäî Ï†úÏô∏)
                  # Í≤ΩÎ°úÎ•º SSHÎ°ú ÌôïÏû•ÌïòÏó¨ Ï†àÎåÄ Í≤ΩÎ°úÎ°ú Î≥ÄÌôò
                  DEPLOY_PATH_RAW="${{ secrets.EC2_DEPLOY_PATH || '~/test-app' }}"
                  ACTUAL_PATH=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
                    ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
                    "case '$DEPLOY_PATH_RAW' in ~*) echo \"\${HOME}${DEPLOY_PATH_RAW#\~}\";; *) echo '$DEPLOY_PATH_RAW';; esac")

                  echo "üìÅ Deploying to: $ACTUAL_PATH"

                  rsync -avz --delete \
                    -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
                    --exclude '.git' \
                    --exclude 'node_modules' \
                    --exclude '.env*' \
                    --exclude '*.log' \
                    --exclude '.DS_Store' \
                    ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$ACTUAL_PATH/

            - name: Run deployment script on EC2
              env:
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  EC2_USER: ${{ secrets.EC2_USER }}
                  DEPLOY_PATH: ${{ secrets.EC2_DEPLOY_PATH || '~/test-app' }}
              run: |
                  ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
                    ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                  set -e

                  # Î∞∞Ìè¨ Í≤ΩÎ°ú ÏÑ§Ï†ï (~Î•º $HOMEÏúºÎ°ú ÌôïÏû•)
                  DEPLOY_PATH_RAW="${{ secrets.EC2_DEPLOY_PATH || '~/test-app' }}"
                  if [[ "$DEPLOY_PATH_RAW" == ~* ]]; then
                    DEPLOY_PATH="${DEPLOY_PATH_RAW/#\~/$HOME}"
                  else
                    DEPLOY_PATH="$DEPLOY_PATH_RAW"
                  fi
                  echo "üìÅ Deployment path: $DEPLOY_PATH"

                  # ÎîîÎ†âÌÜ†Î¶¨Í∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                  mkdir -p "$DEPLOY_PATH"

                  cd "$DEPLOY_PATH" || exit 1

                  # Node.js Î∞è Yarn ÏÑ§Ïπò ÌôïÏù∏ Î∞è ÏÑ§Ïπò
                  if ! command -v node &> /dev/null; then
                    echo "üì¶ Installing Node.js..."
                    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                    sudo apt-get install -y nodejs
                  fi

                  if ! command -v yarn &> /dev/null; then
                    echo "üì¶ Installing Yarn..."
                    curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add - 2>/dev/null || true
                    echo "deb https://dl.yarnpkg.com/debian stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
                    sudo apt-get update
                    sudo apt-get install -y yarn
                  fi

                  echo "‚úÖ Node.js version: $(node --version)"
                  echo "‚úÖ Yarn version: $(yarn --version)"

                  echo "üì¶ Installing dependencies..."
                  yarn install --frozen-lockfile --production=false

                  echo "üåê Installing Playwright browsers..."
                  yarn postinstall || echo "‚ö†Ô∏è Playwright install failed, continuing..."

                  echo "üîÑ Restarting application..."
                  # Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å (sudoÎ°ú Ïã§ÌñâÎêú ÌîÑÎ°úÏÑ∏Ïä§ÎèÑ Ìè¨Ìï®)
                  echo "üõë Stopping existing processes..."
                  pkill -f "next-server" || true
                  sudo pkill -f "next-server" || true
                  sleep 2

                  # ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä ÏôÑÏ†ÑÌûà Ï¢ÖÎ£åÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞ (ÏµúÎåÄ 10Ï¥à)
                  for i in {1..10}; do
                    if ! pgrep -f "next-server" > /dev/null && ! sudo pgrep -f "next-server" > /dev/null; then
                      echo "‚úÖ All processes stopped"
                      break
                    fi
                    echo "‚è≥ Waiting for processes to stop... ($i/10)"
                    sleep 1
                  done

                  # ÌòπÏãú ÎÇ®ÏïÑÏûàÎäî ÌîÑÎ°úÏÑ∏Ïä§ Í∞ïÏ†ú Ï¢ÖÎ£å
                  if pgrep -f "next-server" > /dev/null || sudo pgrep -f "next-server" > /dev/null; then
                    echo "‚ö†Ô∏è Force killing remaining processes..."
                    pkill -9 -f "next-server" || true
                    sudo pkill -9 -f "next-server" || true
                    sleep 2
                  fi

                  # Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïû¨ÏãúÏûë (Î∞±Í∑∏ÎùºÏö¥Îìú)
                  # Ìè¨Ìä∏ 80ÏùÄ privileged portÏù¥ÎØÄÎ°ú sudo ÌïÑÏöî
                  # -E: ÌôòÍ≤Ω Î≥ÄÏàò Î≥¥Ï°¥, env "PATH=$PATH": PATH Î≥¥Ï°¥
                  cd "$DEPLOY_PATH" || exit 1
                  nohup sudo -E env "PATH=$PATH" yarn start:80 > nextjs.log 2>&1 &

                  echo "‚úÖ Deployment completed!"
                  sleep 3


                  # ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏ (sudoÎ°ú Ïã§ÌñâÎêú ÌîÑÎ°úÏÑ∏Ïä§ÎèÑ Ìè¨Ìï®)
                  if pgrep -f "next-server" > /dev/null || sudo pgrep -f "next-server" > /dev/null; then
                    echo "‚úÖ Application is running"
                    ps aux | grep "next-server" | grep -v grep || true
                  else
                    echo "‚ùå Application failed to start"
                    if [ -f nextjs.log ]; then
                      tail -n 50 nextjs.log
                    fi
                    exit 1
                  fi
                  EOF
